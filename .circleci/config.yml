version: 2
jobs:
    build:
        working_directory: ~/circleci-java-spring

        docker:
            - image: tuxmonteiro/rhcircleci

        steps:
            - checkout

            - restore_cache:
                key: circleci-galeb-{{ checksum "pom.xml" }}

            - run:
                name: Define Galeb version
                command: |
                  repo='galeb/galeb4'
                  last=$(curl -s https://api.github.com/repos/$repo/releases/latest | jq -r .tag_name | sed 's/v.\+\..\+\.//')
                  export GALEB_VERSION=4.0.$[last + 1]
                  echo $GALEB_VERSION | tee /tmp/galeb_version

            - run:
                name: Get dependencies
                command: |
                  export GALEB_VERSION=$(cat /tmp/galeb_version)
                  echo $GALEB_VERSION
                  mvn dependency:go-offline

            - save_cache:
                paths:
                    - ~/.m2
                key: circleci-galeb-{{ checksum "pom.xml" }}

            - run:
                name: Build package
                command: mvn package

            - deploy:
                name: Push release
                command: |
                    //if [ "${CIRCLE_BRANCH}" == "master" || "${CIRCLE_BRANCH}" == "develop" ]; then
                      repo='galeb/galeb4'
                      export GALEB_VERSION=$(cat /tmp/galeb_version)
                      echo $GALEB_VERSION
                      make galeb dist
                      upload=$(curl -s -H "Authorization: token $GITHUB_TOKEN" -XPOST -d'{"body": "v'$GALEB_VERSION'", "name": "v'$GALEB_VERSION'", "tag_name": "v'$GALEB_VERSION'"}' https://api.github.com/repos/$repo/releases | jq -r .upload_url | sed 's/{.*//')
                      cd dists/; for pkg in *${GALEB_VERSION}*rpm; do
                        curl -s -H "Authorization: token $GITHUB_TOKEN" -XPOST -H'content-type: application/x-redhat-package-manager' --data-binary @$pkg ${upload}?name=${pkg}
                      done; cd - > /dev/null
                    //fi